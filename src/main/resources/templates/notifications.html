<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì•Œë¦¼í•¨</title>
    <link rel="stylesheet" href="/css/app.css">
</head>
<body class="page">
<h1>ğŸ“¬ ì•Œë¦¼í•¨</h1>
<button id="markAllBtn">ëª¨ë‘ ì½ìŒ</button>
<ul id="notificationList"></ul>

<script>
    function renderNotifications(list, notifications) {
        list.innerHTML = "";
        if (notifications.length === 0) {
            list.innerHTML = "<li>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        notifications.forEach(n => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div>${n.message}</div>
                <div class="timestamp">${new Date(n.createdAt).toLocaleString()}</div>
                <button class="readBtn" data-id="${n.id}">ì½ìŒ</button>
            `;
            list.appendChild(li);
        });
    }

    async function fetchNotifications() {
        const res = await fetch('/api/notifications');
        const json = await res.json();
        if (!json.success) throw new Error(json.message);
        return json.data;
    }

    async function markRead(id) {
        const res = await fetch(`/api/notifications/${id}/read`, { method: 'PATCH' });
        if (!res.ok) {
            const json = await res.json().catch(() => ({}));
            throw new Error(json.message || 'ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
    }

    async function markAllRead() {
        const res = await fetch('/api/notifications/read-all', { method: 'PATCH' });
        if (!res.ok) {
            const json = await res.json().catch(() => ({}));
            throw new Error(json.message || 'ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
    }

    function showError(err) {
        alert(err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(err);
    }

    window.onload = async () => {
        const list = document.getElementById('notificationList');
        const markAllBtn = document.getElementById('markAllBtn');

        let notifications = [];
        try {
            notifications = await fetchNotifications();
            renderNotifications(list, notifications);
        } catch (err) {
            showError(err);
        }

        list.addEventListener('click', async e => {
            if (!e.target.classList.contains('readBtn')) return;
            const id = e.target.dataset.id;
            try {
                // ì½ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ isread trueë¡œ ë³€ê²½
                await markRead(id);
                // ì¦‰ê°ì ì¸ UI ë°˜ì‘ì„ ìœ„í•´ ì½ìŒ ì²˜ë¦¬í•œ ì•Œë¦¼ë§Œ ì œì™¸í•˜ê³  ìƒˆ ë°°ì—´ ìƒì„±
                notifications = notifications.filter(n => n.id !== Number(id));
                // ë³€ê²½ëœ ì•Œë¦¼ ëª©ë¡ì„ ë‹¤ì‹œ í™”ë©´ì— ì¶œë ¥
                renderNotifications(list, notifications);
            } catch (err) {
                showError(err);
            }
        });

        markAllBtn.onclick = async () => {
            if (!confirm('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await markAllRead();
                notifications = [];
                renderNotifications(list, notifications);
            } catch (err) {
                showError(err);
            }
        };
    };
</script>
</body>
</html>
