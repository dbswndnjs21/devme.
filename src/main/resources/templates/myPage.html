<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <link rel="stylesheet" href="/css/myPage.css">
    <link rel="stylesheet" href="/css/app.css">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        #studyList, #studyManage, #calendarSection {
            display: none;
        }

        #calendar {
            max-width: 900px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            overflow: hidden;
            height: auto;
        }
    </style>
</head>
<body class="page">
<div id="container">
    <!-- 왼쪽 메뉴 -->
    <nav id="sidebar">
        <h2>내 계정</h2>
        <ul>
            <li><a href="#" id="editProfile">내정보 관리</a></li>
            <li><a href="#" id="studyListMenu">내 스터디 목록</a></li>
            <li><a href="#" id="manageStudiesMenu">내 스터디 신청자 관리</a></li>
            <li><a href="#" id="calendarMenu">일정 관리</a></li>
        </ul>
    </nav>

    <!-- 오른쪽 컨텐츠 -->
    <div id="content">
        <h1>마이페이지</h1>

        <!-- 내 스터디 목록 -->
        <div id="studyList">
            <h2>내 스터디 목록</h2>
            <table>
                <thead>
                <tr>
                    <th>스터디 제목</th>
                    <th>상태</th>
                    <th>직급</th>
                </tr>
                </thead>
                <tbody id="studyListBody"></tbody>
            </table>
        </div>

        <!-- 스터디 신청자 관리 -->
        <div id="studyManage">
            <h2>내 스터디 신청자 관리</h2>
            <table>
                <thead>
                <tr>
                    <th>스터디 제목</th>
                    <th>신청자</th>
                    <th>상태</th>
                    <th>신청 시간</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody id="studyManageBody"></tbody>
            </table>
        </div>

        <!-- 일정 관리 -->
        <div id="calendarSection">
            <h2>출석 및 일정 관리</h2>
            <div id="calendar"></div>
        </div>

        <!-- 내 정보 관리 -->
        <div id="editProfileSection" style="display: none;">
            <h2>내 정보 수정</h2>
            <form id="editProfileForm">
                <div class="full-width">
                    <label for="username">아이디</label>
                    <input type="text" id="username" name="username" readonly>
                </div>

                <div>
                    <label for="phone">전화번호</label>
                    <input type="text" id="phone" name="phone" required>
                </div>

                <div>
                    <label for="email">이메일</label>
                    <input type="email" id="email" name="email">
                </div>

                <div>
                    <label for="department">부서</label>
                    <input type="text" id="department" name="department">
                </div>

                <div>
                    <label for="position">직급</label>
                    <input type="text" id="position" name="position">
                </div>

                <div class="full-width address-group">
                    <label for="address">주소</label>
                    <div class="address-input-group">
                        <input type="text" id="address" name="address" readonly placeholder="주소 검색 버튼을 눌러주세요">
                        <button type="button" id="addressSearchBtn" onclick="searchAddress()">주소 검색</button>
                    </div>
                </div>

                <!-- 위도/경도 숨김 필드 -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">

                <div class="full-width">
                    <button type="submit">저장</button>
                </div>
            </form>
        </div>

    </div>
</div>




<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
    // 내 스터디 목록
    document.getElementById('studyListMenu').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('studyList').style.display = 'block';
        document.getElementById('studyManage').style.display = 'none';
        document.getElementById('calendarSection').style.display = 'none';
        document.getElementById('editProfileSection').style.display = 'none';

        const studyListBody = document.getElementById('studyListBody');
        studyListBody.innerHTML = '';

        fetch('/api/myStudyList')
            .then(response => response.json())
            .then(data => {
                data.forEach(study => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                       <td>
                         <a href="/study/main/${study.id}" style="text-decoration: none; color: #333;">
                             ${study.title}
                         </a>
                      </td>
                        <td>${study.status}</td>
                        <td>${study.role}</td>
                    `;
                    studyListBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching study list:', error));
    });

    // 스터디 신청자 관리
    function refreshStudyManage() {
        const studyManageBody = document.getElementById('studyManageBody');
        studyManageBody.innerHTML = '';

        fetch('/api/myManagedStudies')
            .then(response => response.json())
            .then(data => {
                data.forEach(study => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${study.studyTitle}</td>
                        <td>${study.userName}</td>
                        <td>${study.status}</td>
                        <td>${study.createdAt}</td>
                        <td>
                            <button class="approveBtn" data-request-id="${study.requestId}">승인</button>
                            <button class="rejectBtn" data-request-id="${study.requestId}">거부</button>
                        </td>
                    `;
                    studyManageBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching managed studies:', error));
    }

    document.getElementById('manageStudiesMenu').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('studyList').style.display = 'none';
        document.getElementById('studyManage').style.display = 'block';
        document.getElementById('calendarSection').style.display = 'none';
        document.getElementById('editProfileSection').style.display = 'none';
        refreshStudyManage();
    });

    document.getElementById('studyManage').addEventListener('click', function(event) {
        if (event.target.classList.contains('approveBtn')) {
            const requestId = event.target.getAttribute('data-request-id');
            fetch(`/api/approveRequest/${requestId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('신청 승인 완료');
                        refreshStudyManage();
                    } else {
                        throw new Error('승인 실패');
                    }
                })
                .catch(error => alert('승인 실패: ' + error.message));
        }

        if (event.target.classList.contains('rejectBtn')) {
            const requestId = event.target.getAttribute('data-request-id');
            fetch(`/api/rejectRequest/${requestId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('신청 거부 완료');
                        refreshStudyManage();
                    } else {
                        throw new Error('거부 실패');
                    }
                })
                .catch(error => alert('거부 실패: ' + error.message));
        }
    });

    // 일정관리 (출석 캘린더)
    let calendar;
    document.getElementById('calendarMenu').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('studyList').style.display = 'none';
        document.getElementById('studyManage').style.display = 'none';
        document.getElementById('calendarSection').style.display = 'block';
        document.getElementById('editProfileSection').style.display = 'none';

        if (!calendar) {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                contentHeight: 'auto',
                expandRows: true,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                events: fetchAttendanceEvents,

                eventDidMount: function(info) {
                    if (info.event.extendedProps.description) {
                        // title 요소에 description을 툴팁으로 설정
                        info.el.setAttribute("title", info.event.extendedProps.description);
                    }
                }
            });
            calendar.render();
            setTimeout(() => calendar.updateSize(), 10);
        }
    });

    function fetchAttendanceEvents(fetchInfo, successCallback, failureCallback) {
        Promise.all([
            fetch('/api/myAttendance').then(res => res.json()),
            fetch('/api/mySchedule').then(res => res.json())
        ])
            .then(([attendanceRes, scheduleRes]) => {
                const events = [];

                if (attendanceRes.success) {
                    const attendanceEvents = attendanceRes.data.map(item => ({
                        title: item.title,
                        start: item.start,
                        color: item.color
                    }));
                    events.push(...attendanceEvents);
                }

                if (scheduleRes.success) {
                    const scheduleEvents = scheduleRes.data.map(item => ({
                        title: item.title,
                        start: item.date,
                        description: item.description,
                        color: item.color
                    }));
                    events.push(...scheduleEvents);
                }

                successCallback(events);
            })
            .catch(error => {
                console.error('Error loading calendar data:', error);
                failureCallback(error);
            });
    }

    // 내 정보 관리 이벤트
    document.getElementById('editProfile').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('editProfileSection').style.display = 'block';
        document.getElementById('studyList').style.display = 'none';
        document.getElementById('studyManage').style.display = 'none';
        document.getElementById('calendarSection').style.display = 'none';

        // 사용자 정보 불러오기
        fetch('/api/myProfile')
            .then(response => response.json())
            .then(res => {
                if (res.success) {
                    const data = res.data;
                    document.getElementById('username').value = data.username;
                    document.getElementById('phone').value = data.phone;
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('department').value = data.department || '';
                    document.getElementById('position').value = data.position || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('latitude').value = data.latitude || '';
                    document.getElementById('longitude').value = data.longitude || '';
                } else {
                    alert('내 정보 불러오기 실패');
                }
            })
            .catch(error => console.error('Error fetching profile:', error));
    });

    // 프로필 저장
    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = {
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            department: document.getElementById('department').value,
            position: document.getElementById('position').value,
            address: document.getElementById('address').value,
            latitude: document.getElementById('latitude').value || null,
            longitude: document.getElementById('longitude').value || null
        };

        fetch('/api/updateProfile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(res => {
                console.log(res)
                if (res.success) {
                    alert('정보가 수정되었습니다.');
                } else {
                    alert('정보 수정 실패');
                }
            })
            .catch(error => alert('에러 발생: ' + error.message));
    });

    // 주소 검색 함수
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                const fullAddress = data.address;
                document.getElementById('address').value = fullAddress;

                // 카카오 Geocoding API 호출 (주소 → 좌표)
                fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(fullAddress)}`, {
                    method: 'GET',
                    headers: {
                        Authorization: 'KakaoAK 631c3f361a731d3b52e0813714eece53'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.documents.length > 0) {
                            const location = data.documents[0];
                            document.getElementById('latitude').value = location.y;  // 위도
                            document.getElementById('longitude').value = location.x; // 경도
                            console.log('주소:', fullAddress, '위도:', location.y, '경도:', location.x);
                        } else {
                            alert("좌표를 찾을 수 없습니다.");
                            // 좌표를 찾지 못한 경우 기존 값 유지 또는 초기화
                            document.getElementById('latitude').value = '';
                            document.getElementById('longitude').value = '';
                        }
                    })
                    .catch(error => {
                        console.error('주소 → 좌표 변환 실패:', error);
                        alert("좌표 변환 중 오류가 발생했습니다.");
                        // 오류 발생 시 좌표 필드 초기화
                        document.getElementById('latitude').value = '';
                        document.getElementById('longitude').value = '';
                    });
            }
        }).open();
    }

</script>
</body>
</html>
