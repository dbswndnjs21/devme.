<!DOCTYPE html>
<html>
<head>
    <title>ìŠ¤í„°ë”” ëª©ë¡</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }

        /* ê²€ìƒ‰ ì˜ì—­ */
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 250px;
        }
        .search-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-btn:hover { background: #0056b3; }
        .filter-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        /* ê²°ê³¼ ì •ë³´ */
        .results-info {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        /* ìŠ¤í„°ë”” ì¹´ë“œ */
        .study-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        .study-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .study-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .study-desc {
            color: #666;
            margin: 8px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .study-meta {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .study-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 8px;
        }
        .status-inprogress { background: #e3f2fd; color: #1976d2; }
        .status-completed { background: #f3e5f5; color: #7b1fa2; }

        /* í˜ì´ì§• */
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        .pagination button {
            padding: 8px 12px;
            margin: 0 2px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover { background: #f8f9fa; }
        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* ë¡œë”© & ë¹ˆ ìƒíƒœ */
        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state {
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“š ìŠ¤í„°ë”” ëª©ë¡</h1>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input"
                   placeholder="ìŠ¤í„°ë”” ì œëª©, ë‚´ìš©, ëª©í‘œ, ì‚¬ìš© ë„êµ¬ë¡œ ê²€ìƒ‰...">
            <button onclick="searchStudies()" class="search-btn">ğŸ” ê²€ìƒ‰</button>
            <select id="statusFilter" class="filter-select" onchange="searchStudies()">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="INPROGRESS">ì§„í–‰ì¤‘</option>
                <option value="COMPLETED">ì™„ë£Œ</option>
            </select>
            <button onclick="resetSearch()" class="search-btn" style="background: #6c757d;">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ê²°ê³¼ ì •ë³´ -->
    <div id="resultsInfo" class="results-info"></div>

    <!-- ìŠ¤í„°ë”” ëª©ë¡ -->
    <div id="studyList" class="study-grid">
        <div class="loading">ìŠ¤í„°ë”” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- í˜ì´ì§• -->
    <div id="pagination" class="pagination"></div>
</div>

<script>
    let currentPage = 0;
    let currentKeyword = '';
    let currentStatus = '';
    let isSearchMode = false;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ëª©ë¡ ì¡°íšŒ
    document.addEventListener('DOMContentLoaded', function() {
        loadAllStudies();
    });

    // ì „ì²´ ìŠ¤í„°ë”” ëª©ë¡ ì¡°íšŒ (ê¸°ì¡´ API ì‚¬ìš©)
    async function loadAllStudies(page = 0) {
        try {
            const response = await fetch('/api/studyList');
            const studies = await response.json();

            if (Array.isArray(studies)) {
                displayStudies(studies);
                updateResultsInfo(studies.length, 0, false);
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('ìŠ¤í„°ë”” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            showEmptyState('ìŠ¤í„°ë”” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function searchStudies(page = 0) {
        const keyword = document.getElementById('searchInput').value.trim();
        const status = document.getElementById('statusFilter').value;

        currentPage = page;
        currentKeyword = keyword;
        currentStatus = status;
        isSearchMode = keyword !== '' || status !== '';

        if (!isSearchMode) {
            // ê²€ìƒ‰ì–´ì™€ í•„í„°ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ëª©ë¡ ì¡°íšŒ
            loadAllStudies();
            return;
        }

        try {
            let url = `/api/search/studies?page=${page}&size=12`;
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
            if (status) url += `&status=${status}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.success && result.data) {
                displayStudies(result.data.content);
                displayPagination(result.data);
                updateResultsInfo(result.data.totalElements, result.data.number, true);
            } else {
                showEmptyState('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
            showEmptyState('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê²€ìƒ‰ ì´ˆê¸°í™”
    function resetSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        currentKeyword = '';
        currentStatus = '';
        isSearchMode = false;
        currentPage = 0;
        loadAllStudies();
    }

    // ìŠ¤í„°ë”” ëª©ë¡ í™”ë©´ì— í‘œì‹œ
    function displayStudies(studies) {
        const container = document.getElementById('studyList');

        if (!studies || studies.length === 0) {
            showEmptyState();
            return;
        }

        container.innerHTML = studies.map(study => {
            // Elasticsearch ê²°ê³¼ì™€ DB ê²°ê³¼ í˜•íƒœ í†µì¼
            const title = study.title;
            const description = study.description;
            const maxMembers = study.maxMembers;
            const status = study.status;
            const createdBy = study.createdByUsername || (study.createdBy && study.createdBy.username);

            return `
                    <div class="study-card" onclick="goToStudyDetail(${study.id || study.id})">
                        <div class="study-title">${title}</div>
                        <div class="study-desc">${description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        <div class="study-meta">
                            ğŸ‘¤ ${createdBy} | ğŸ‘¥ ìµœëŒ€ ${maxMembers}ëª…
                            <span class="study-status status-${status.toLowerCase()}">${status}</span>
                        </div>
                    </div>
                `;
        }).join('');
    }

    // ê²°ê³¼ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateResultsInfo(totalElements, currentPage, isSearch) {
        const info = document.getElementById('resultsInfo');
        if (isSearch) {
            info.innerHTML = `ğŸ” ê²€ìƒ‰ ê²°ê³¼: <strong>${totalElements}ê°œ</strong> (${currentPage + 1} í˜ì´ì§€)`;
        } else {
            info.innerHTML = `ğŸ“‹ ì „ì²´ ìŠ¤í„°ë””: <strong>${totalElements}ê°œ</strong>`;
        }
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState(message = 'ë“±ë¡ëœ ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.') {
        const container = document.getElementById('studyList');
        container.innerHTML = `<div class="empty-state">${message}</div>`;
        document.getElementById('pagination').innerHTML = '';
        document.getElementById('resultsInfo').innerHTML = '';
    }

    // í˜ì´ì§• í‘œì‹œ (ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œë§Œ)
    function displayPagination(pageData) {
        const container = document.getElementById('pagination');

        if (!isSearchMode || pageData.totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        const totalPages = pageData.totalPages;
        const currentPage = pageData.number;

        let paginationHtml = '';

        // ì´ì „ ë²„íŠ¼
        if (currentPage > 0) {
            paginationHtml += `<button onclick="searchStudies(${currentPage - 1})">â€¹ ì´ì „</button>`;
        }

        // í˜ì´ì§€ ë²ˆí˜¸ë“¤
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 3);

        for (let i = startPage; i < endPage; i++) {
            const isActive = i === currentPage ? 'active' : '';
            paginationHtml += `<button class="${isActive}" onclick="searchStudies(${i})">${i + 1}</button>`;
        }

        // ë‹¤ìŒ ë²„íŠ¼
        if (currentPage < totalPages - 1) {
            paginationHtml += `<button onclick="searchStudies(${currentPage + 1})">ë‹¤ìŒ â€º</button>`;
        }

        container.innerHTML = paginationHtml;
    }

    // ìŠ¤í„°ë”” ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function goToStudyDetail(studyId) {
        window.location.href = `/study/detail/${studyId}`;
    }

    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchStudies(0);
        }
    });
</script>
</body>
</html>