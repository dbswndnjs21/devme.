<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>스터디 메인</title>
    <link rel="stylesheet" href="/css/studyMain.css">
</head>
<body>
<div id="container">
    <!-- 좌측 메뉴 -->
    <nav id="sidebar">
        <h2>스터디 메뉴</h2>
        <ul>
            <li><a href="/myPage">마이페이지</a></li>
            <li><a href="#">공지사항</a></li>
            <li id="adminMenu" style="display: none;"><a href="#">관리자 페이지</a></li>
        </ul>
    </nav>

    <!-- 우측 콘텐츠 -->
    <div id="content">
        <h1 id="studyTitle">스터디 제목</h1>

        <div class="section">
            <h2>스터디 정보</h2>
            <p>상태: <span id="studyStatus">로딩 중...</span></p>

            <button id="startAttendanceBtn">출석 시작</button>
            <p id="attendanceStatus">출석을 시작해주세요.</p>
        </div>

        <div class="section">
            <h2>공지사항</h2>
            <p>추후 공지 추가 예정</p>
        </div>

        <div class="section">
            <h2>스터디 멤버</h2>
            <ul id="memberList"></ul>
        </div>
    </div>
</div>

<script>
    const studyId = window.location.pathname.split("/").pop();

    // 스터디 메인 정보 불러오기
    fetch(`/api/study/main/${studyId}`)
        .then(response => response.json())
        .then(data => {
            console.log(data)
            document.getElementById('studyTitle').innerText = data.study.title;
            document.getElementById('studyStatus').innerText = data.study.status;

            const memberList = document.getElementById('memberList');
            data.studyMember.forEach(member => {
                const li = document.createElement('li');
                li.innerText = `${member.user.id} (${member.role})`;
                memberList.appendChild(li);
            });

            // 관리자 페이지 사용 여부 판단
            if (data.leader) {
                document.getElementById('adminMenu').style.display = 'block';
            }
        })
        .catch(err => {
            alert("스터디 정보를 불러오지 못했습니다.");
            console.error(err);
        });

    let timer = null;
    let countdown = 30 * 60; // 30분 (초 단위)

    document.getElementById('startAttendanceBtn').addEventListener('click', function () {
        if (timer) {
            alert("이미 출석 중입니다.");
            return;
        }

        const status = document.getElementById('attendanceStatus');
        status.innerText = `출석 중... 남은 시간: ${formatTime(countdown)}`;

        timer = setInterval(() => {
            countdown--;
            status.innerText = `출석 중... 남은 시간: ${formatTime(countdown)}`;

            if (countdown <= 0) {
                clearInterval(timer);
                timer = null;
                status.innerText = "출석 완료 처리 중...";

                fetch(`/api/study/${studyId}/attendance`, { method: 'POST' })
                    .then(res => {
                        if (res.ok) {
                            status.innerText = "출석이 완료되었습니다!";
                        } else {
                            status.innerText = "출석 처리 실패";
                        }
                    })
                    .catch(() => {
                        status.innerText = "출석 처리 실패 (네트워크 오류)";
                    });
            }
        }, 1000);
    });

    function formatTime(seconds) {
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${mins}:${secs}`;
    }
</script>
</body>
</html>
