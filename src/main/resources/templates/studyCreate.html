<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>스터디 생성</title>
  <link rel="stylesheet" href="/css/studyCreate.css">
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
<h1>스터디 생성</h1>

<form id="studyForm">
  <label for="name">스터디 이름:</label><br>
  <input type="text" id="name" name="name" required><br>

  <label for="description">설명:</label><br>
  <textarea id="description" name="description" rows="4" cols="50" required></textarea><br>

  <label for="maxMembers">최대 인원 수:</label><br>
  <input type="number" id="maxMembers" name="maxMembers" min="2" required><br>

  <label for="goal">스터디 목표:</label><br>
  <textarea id="goal" name="goal" rows="4" cols="50" required></textarea><br>

  <label for="howToProceed">진행 방식:</label><br>
  <textarea id="howToProceed" name="howToProceed" rows="4" cols="50" required></textarea><br>

  <label for="tools">사용 도구:</label><br>
  <textarea id="tools" name="tools" rows="4" cols="50" required></textarea><br>

  <label for="rules">규칙:</label><br>
  <textarea id="rules" name="rules" rows="4" cols="50" required></textarea><br>

  <label for="schedule">일정:</label><br>
  <textarea id="schedule" name="schedule" rows="4" cols="50" required></textarea><br>

  <!-- 주소 검색 섹션 -->
  <label for="address">스터디 장소 (선택사항):</label><br>
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <input type="text" id="address" name="address" placeholder="오프라인 스터디인 경우 주소 검색 버튼을 클릭해주세요" readonly style="flex: 1; width: 300px;">
    <button type="button" id="addressSearchBtn" style="white-space: nowrap; padding: 8px 12px;">주소 검색</button>
  </div>
  <input type="text" id="detailAddress" name="detailAddress" placeholder="상세 주소 (건물명, 층수 등)" style="width: 100%; margin-bottom: 10px;"><br>

  <button type="submit">생성하기</button>
</form>

<div id="result"></div>

<script>
  const form = document.getElementById('studyForm');
  const resultDiv = document.getElementById('result');
  const addressInput = document.getElementById('address');
  const detailAddressInput = document.getElementById('detailAddress');
  const addressSearchBtn = document.getElementById('addressSearchBtn');

  // 주소 검색 기능
  addressSearchBtn.addEventListener('click', function() {
    new daum.Postcode({
      oncomplete: function(data) {
        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
        var addr = ''; // 주소 변수

        //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
          addr = data.roadAddress;
        } else { // 사용자가 지번 주소를 선택했을 경우(J)
          addr = data.jibunAddress;
        }

        // 선택된 주소를 입력 필드에 넣는다.
        addressInput.value = addr;

        // 상세주소 필드에 포커스를 준다.
        detailAddressInput.focus();
      }
    }).open();
  });

  // 폼 제출 처리
  form.addEventListener('submit', function (e) {
    e.preventDefault();

    // 기본 주소와 상세주소를 합친다 (주소가 있는 경우에만)
    // const fullAddress = addressInput.value ?
    //         (addressInput.value + (detailAddressInput.value ? ' ' + detailAddressInput.value : '')) :
    //         null;

    const data = {
      name: document.getElementById('name').value,
      description: document.getElementById('description').value,
      maxMembers: document.getElementById('maxMembers').value,
      goal: document.getElementById('goal').value,
      howToProceed: document.getElementById('howToProceed').value,
      tools: document.getElementById('tools').value,
      rules: document.getElementById('rules').value,
      schedule: document.getElementById('schedule').value,
      baseAddress: addressInput.value,  //  좌표 변환용 (카카오 API 호출용)
      detailAddress: detailAddressInput.value //  DB 저장용
    };

    fetch('/api/studyCreate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
            .then(res => {
              if (!res.ok) throw new Error('스터디 생성 실패');
              return res.text();
            })
            .then(msg => {
              resultDiv.innerText = msg;
              form.reset();
              alert(msg)
              window.location.href = "/";
            })
            .catch(err => {
              resultDiv.innerText = err.message;
            });
  });
</script>
</body>
</html>