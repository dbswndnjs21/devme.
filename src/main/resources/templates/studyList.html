<!DOCTYPE html>
<html>
<head>
    <title>ìŠ¤í„°ë”” ëª©ë¡</title>
    <link rel="stylesheet" href="/css/studyList.css">
</head>
<body>
<div class="container">
    <h1>ğŸ“š ìŠ¤í„°ë”” ëª©ë¡</h1>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input"
                   placeholder="ìŠ¤í„°ë”” ì œëª©, ë‚´ìš©, ëª©í‘œ, ì‚¬ìš© ë„êµ¬ë¡œ ê²€ìƒ‰...">
            <button onclick="searchStudies()" class="search-btn">ğŸ” ê²€ìƒ‰</button>
            <select id="statusFilter" class="filter-select" onchange="searchStudies()">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="INPROGRESS">ì§„í–‰ì¤‘</option>
                <option value="COMPLETED">ì™„ë£Œ</option>
            </select>
            <button onclick="resetSearch()" class="search-btn" style="background: #6c757d;">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ê²°ê³¼ ì •ë³´ -->
    <div id="resultsInfo" class="results-info"></div>

    <!-- ìŠ¤í„°ë”” ëª©ë¡ -->
    <div id="studyList" class="study-grid">
        <div class="loading">ìŠ¤í„°ë”” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- í˜ì´ì§• -->
    <div id="pagination" class="pagination"></div>
</div>

<script>
    let currentPage = 0;
    let currentKeyword = '';
    let currentStatus = '';
    let isSearchMode = false;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ëª©ë¡ ì¡°íšŒ
    document.addEventListener('DOMContentLoaded', function() {
        loadAllStudies();
    });

    // ì „ì²´ ìŠ¤í„°ë”” ëª©ë¡ ì¡°íšŒ (ê¸°ì¡´ API ì‚¬ìš©)
    async function loadAllStudies(page = 0) {
        try {
            const response = await fetch('/api/studyList');
            const studies = await response.json();

            if (Array.isArray(studies)) {
                displayStudies(studies);
                updateResultsInfo(studies.length, 0, false);
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('ìŠ¤í„°ë”” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            showEmptyState('ìŠ¤í„°ë”” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function searchStudies(page = 0) {
        const keyword = document.getElementById('searchInput').value.trim();
        const status = document.getElementById('statusFilter').value;

        currentPage = page;
        currentKeyword = keyword;
        currentStatus = status;
        isSearchMode = keyword !== '' || status !== '';

        if (!isSearchMode) {
            // ê²€ìƒ‰ì–´ì™€ í•„í„°ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ëª©ë¡ ì¡°íšŒ
            loadAllStudies();
            return;
        }

        try {
            let url = `/api/search/studies?page=${page}&size=12`;
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
            if (status) url += `&status=${status}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.success && result.data) {
                displayStudies(result.data.content);
                displayPagination(result.data);
                updateResultsInfo(result.data.totalElements, result.data.number, true);
            } else {
                showEmptyState('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
            showEmptyState('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê²€ìƒ‰ ì´ˆê¸°í™”
    function resetSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        currentKeyword = '';
        currentStatus = '';
        isSearchMode = false;
        currentPage = 0;
        loadAllStudies();
    }

    // ìŠ¤í„°ë”” ëª©ë¡ í™”ë©´ì— í‘œì‹œ
    function displayStudies(studies) {
        const container = document.getElementById('studyList');

        if (!studies || studies.length === 0) {
            showEmptyState();
            return;
        }

        container.innerHTML = studies.map(study => {
            // Elasticsearch ê²°ê³¼ì™€ DB ê²°ê³¼ í˜•íƒœ í†µì¼
            const title = study.title;
            const description = study.description;
            const maxMembers = study.maxMembers;
            const status = study.status;
            const createdBy = study.createdByUsername || (study.createdBy && study.createdBy.username);

            return `
                    <div class="study-card" onclick="goToStudyDetail(${study.id || study.id})">
                        <div class="study-title">${title}</div>
                        <div class="study-desc">${description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        <div class="study-meta">
                            ğŸ‘¤ ${createdBy} | ğŸ‘¥ ìµœëŒ€ ${maxMembers}ëª…
                            <span class="study-status status-${status.toLowerCase()}">${status}</span>
                        </div>
                    </div>
                `;
        }).join('');
    }

    // ê²°ê³¼ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateResultsInfo(totalElements, currentPage, isSearch) {
        const info = document.getElementById('resultsInfo');
        if (isSearch) {
            info.innerHTML = `ğŸ” ê²€ìƒ‰ ê²°ê³¼: <strong>${totalElements}ê°œ</strong> (${currentPage + 1} í˜ì´ì§€)`;
        } else {
            info.innerHTML = `ğŸ“‹ ì „ì²´ ìŠ¤í„°ë””: <strong>${totalElements}ê°œ</strong>`;
        }
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState(message = 'ë“±ë¡ëœ ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.') {
        const container = document.getElementById('studyList');
        container.innerHTML = `<div class="empty-state">${message}</div>`;
        document.getElementById('pagination').innerHTML = '';
        document.getElementById('resultsInfo').innerHTML = '';
    }

    // í˜ì´ì§• í‘œì‹œ (ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œë§Œ)
    function displayPagination(pageData) {
        const container = document.getElementById('pagination');

        if (!isSearchMode || pageData.totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        const totalPages = pageData.totalPages;
        const currentPage = pageData.number;

        let paginationHtml = '';

        // ì´ì „ ë²„íŠ¼
        if (currentPage > 0) {
            paginationHtml += `<button onclick="searchStudies(${currentPage - 1})">â€¹ ì´ì „</button>`;
        }

        // í˜ì´ì§€ ë²ˆí˜¸ë“¤
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 3);

        for (let i = startPage; i < endPage; i++) {
            const isActive = i === currentPage ? 'active' : '';
            paginationHtml += `<button class="${isActive}" onclick="searchStudies(${i})">${i + 1}</button>`;
        }

        // ë‹¤ìŒ ë²„íŠ¼
        if (currentPage < totalPages - 1) {
            paginationHtml += `<button onclick="searchStudies(${currentPage + 1})">ë‹¤ìŒ â€º</button>`;
        }

        container.innerHTML = paginationHtml;
    }

    // ìŠ¤í„°ë”” ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function goToStudyDetail(studyId) {
        window.location.href = `/study/detail/${studyId}`;
    }

    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchStudies(0);
        }
    });
</script>
</body>
</html>